<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yuffin-Archive Viewer</title>
    <style>
        :root {
            --bg-color: #282c34;
            --text-color: #abb2bf;
            --border-color: #444;
            --accent-color: #61afef;
            --accent-hover: #528baf;
            --placeholder-bg: #3a3f4b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            text-align: center;
        }

        .top-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px; /* Naprawiono typo botvolume -> bottom */
        }

        label.button {
            background-color: var(--accent-color);
            color: var(--bg-color);
            padding: 12px 25px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        label.button:hover {
            background-color: var(--accent-hover);
        }

        input[type="file"] {
            display: none;
        }

        #filter-container select {
            background-color: #4b5263;
            color: white;
            border: 1px solid #666;
            padding: 12px;
            border-radius: 5px;
            font-size: 16px;
        }

        #view-toggle-container {
            display: none;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0; /* Naprawiono typo botvolume -> bottom */
            background-color: #4b5263;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px; /* Naprawiono typo botvolume -> bottom */
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent-color);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        #gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            min-height: 50vh;
        }

        .gallery-item {
            width: 100%;
            padding-top: 75%;
            background-color: var(--placeholder-bg);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .gallery-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.4s;
        }

        .gallery-item img.loaded {
            opacity: 1;
        }

        #gallery.comic-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            margin: 0;
            padding: 0;
        }

        #gallery.comic-view .gallery-item {
            width: 100%;
            max-width: 1000px;
            padding-top: 0;
            height: auto;
            background-color: transparent;
            margin: 0;
            border: none;
        }

        #gallery.comic-view .gallery-item img {
            position: static;
            width: 100%;
            height: auto;
            object-fit: contain;
            display: block;
            margin: 0;
            padding: 0;
        }

        #chapter-navigation {
            display: none;
            margin: 20px 0;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }

        #chapter-navigation button {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        #chapter-navigation button:hover {
            background-color: var(--accent-hover);
        }

        #chapter-navigation button:disabled {
            background-color: #4b5263;
            cursor: not-allowed;
            opacity: 0.5;
        }

        #current-chapter {
            font-size: 18px;
            font-weight: bold;
            padding: 0 15px;
        }

        /* Naprawiono ID w CSS: botvolume -> bottom */
        #chapter-navigation-bottom {
            display: none;
            margin: 20px 0;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }

        #chapter-navigation-bottom button {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        #chapter-navigation-bottom button:hover {
            background-color: var(--accent-hover);
        }

        #chapter-navigation-bottom button:disabled {
            background-color: #4b5263;
            cursor: not-allowed;
            opacity: 0.5;
        }

        #current-chapter-bottom {
            font-size: 18px;
            font-weight: bold;
            padding: 0 15px;
        }

        #status {
            font-size: 18px;
            min-height: 25px;
        }

        #pagination {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        #pagination button,
        #pagination input {
            background: #4b5263;
            color: white;
            border: 1px solid #666;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        #pagination button:disabled {
            background: #3a3f4b;
            cursor: not-allowed;
        }

        #pagination input[type="number"] {
            width: 60px;
            text-align: center;
            -moz-appearance: textfield;
        }

        #pagination input::-webkit-outer-spin-button,
        #pagination input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #pagination .page-info {
            padding: 0 10px;
        }

        #lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        #lightbox.visible {
            opacity: 1;
            visibility: visible;
        }

        #lightbox img {
            max-width: 90vw;
            max-height: 90vh;
        }

        #close-button {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 40px;
            color: white;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Yuffin File Gallery</h1>
        <div class="top-bar">
            <label for="fileInput" class="button">Select .yufi file</label>
            <input type="file" id="fileInput" accept=".yufi">
            <div id="filter-container" style="display: none;">
                <select id="dir-filter"></select>
            </div>
            <div id="view-toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="view-toggle">
                    <span class="slider"></span>
                </label>
                <span>Comic View</span>
            </div>
        </div>
        <div id="chapter-navigation">
            <button id="prev-chapter">Previous Chapter</button>
            <span id="current-chapter"></span>
            <button id="next-chapter">Next Chapter</button>
        </div>
        <p id="status">Select a file to begin.</p>
        <div id="gallery"></div>
        <div id="pagination"></div>
        
        <!-- Naprawiono ID w HTML: botvolume -> bottom, aby zgadzały się z JS -->
        <div id="chapter-navigation-bottom" style="display: none; margin: 20px 0; gap: 15px;">
            <button id="prev-chapter-bottom">Previous Chapter</button>
            <span id="current-chapter-bottom"></span>
            <button id="next-chapter-bottom">Next Chapter</button>
        </div>
    </div>
    <div id="lightbox"><span id="close-button">&times;</span><img id="lightbox-image" src="" alt="Enlarged image">
    </div>
    <script>
    const MAGIC_HEADER_STR = 'Yuffin';
    const fileInput = document.getElementById('fileInput');
    const gallery = document.getElementById('gallery');
    const statusEl = document.getElementById('status');
    const paginationContainer = document.getElementById('pagination');
    const filterContainer = document.getElementById('filter-container');
    const dirFilter = document.getElementById('dir-filter');
    const viewToggleContainer = document.getElementById('view-toggle-container');
    const viewToggle = document.getElementById('view-toggle');
    const lightbox = document.getElementById('lightbox');
    const closeButton = document.getElementById('close-button');
    const lightboxImage = document.getElementById('lightbox-image');
    
    // Górna nawigacja
    const chapterNavigation = document.getElementById('chapter-navigation');
    const prevChapterBtn = document.getElementById('prev-chapter');
    const nextChapterBtn = document.getElementById('next-chapter');
    const currentChapterEl = document.getElementById('current-chapter');
    
    // Dolna nawigacja (teraz ID się zgadzają z HTML)
    const chapterNavigationBottom = document.getElementById('chapter-navigation-bottom');
    const prevChapterBottomBtn = document.getElementById('prev-chapter-bottom');
    const nextChapterBottomBtn = document.getElementById('next-chapter-bottom');
    const currentChapterBottomEl = document.getElementById('current-chapter-bottom');

    let yufiFileHandle = null;
    let allImages = [];
    let filteredImages = [];
    let directories = [];
    let sortedChapterDirs = [];
    let currentChapterIndex = 0;
    const IMAGES_PER_PAGE = 36;
    let currentPage = 1;

    // Funkcja do wyodrębnienia numerów z nazwy rozdziału (ignoruje wielkość liter)
    function extractChapterInfo(chapterName) {
        const lowerChapter = chapterName.toLowerCase();
        
        // Sprawdź format z tomem: Tom_X_Chapter_Y
        const tomMatch = lowerChapter.match(/tom_(\d+)_chapter_(\d+)/i);
        if (tomMatch) {
            return {
                tom: parseInt(tomMatch[1]),
                chapter: parseInt(tomMatch[2]),
                originalName: chapterName
            };
        }
        
        // Sprawdź format bez tomu: Chapter_X
        const chapterMatch = lowerChapter.match(/^chapter_(\d+)/i);
        if (chapterMatch) {
            return {
                tom: 0, // Dla sortowania, rozdziały bez tomu traktujemy jako tom 0
                chapter: parseInt(chapterMatch[1]),
                originalName: chapterName
            };
        }
        
        return null;
    }

    // Funkcja do formatowania nazwy rozdziału do wyświetlenia
    function formatChapterForDisplay(chapterName) {
        const info = extractChapterInfo(chapterName);
        if (!info) return chapterName;
        
        if (info.tom > 0) {
            return `Tom ${info.tom}, Rozdział ${info.chapter}`;
        } else {
            return `Rozdział ${info.chapter}`;
        }
    }

    function sortChapterDirectories(dirs) {
        // Filtruj foldery, które są rozdziałami (ignorując wielkość liter)
        const chapterDirs = dirs.filter(dir => {
            const lowerDir = dir.toLowerCase();
            return /(?:tom_\d+_)?chapter_\d+/i.test(lowerDir);
        });
        
        // Sortuj foldery rozdziałów
        const dirsWithNumbers = chapterDirs.map(dir => {
            const info = extractChapterInfo(dir);
            return {
                original: dir,
                tom: info ? info.tom : 0,
                chapter: info ? info.chapter : 0
            };
        });
        
        // Sortuj najpierw według tomu, potem według rozdziału
        dirsWithNumbers.sort((a, b) => {
            if (a.tom !== b.tom) {
                return a.tom - b.tom;
            }
            return a.chapter - b.chapter;
        });
        
        return dirsWithNumbers.map(dir => dir.original);
    }

    function populateFilter() {
        dirFilter.innerHTML = '<option value="-1">All directories</option>';
        sortedChapterDirs = sortChapterDirectories(directories);
        
        // Dodaj foldery rozdziałów
        sortedChapterDirs.forEach((dir) => {
            const dirId = directories.findIndex(d => d.toLowerCase() === dir.toLowerCase());
            if (dirId !== -1) {
                const option = document.createElement('option');
                option.value = dirId;
                option.textContent = dir;
                dirFilter.appendChild(option);
            }
        });
        
        // Dodaj pozostałe foldery (nie-rozdziały)
        directories.forEach((dir, dirId) => {
            const lowerDir = dir.toLowerCase();
            const isChapterDir = /(?:tom_\d+_)?chapter_\d+/i.test(lowerDir);
            if (!isChapterDir) {
                const option = document.createElement('option');
                option.value = dirId;
                option.textContent = (dir === '' || dir === '.') ? '[Root Directory]' : dir;
                dirFilter.appendChild(option);
            }
        });
        
        filterContainer.style.display = 'block';
        viewToggleContainer.style.display = 'flex';
    }

    function cleanup() {
        gallery.innerHTML = '';
        paginationContainer.innerHTML = '';
        filterContainer.style.display = 'none';
        viewToggleContainer.style.display = 'none';
        chapterNavigation.style.display = 'none';
        if (viewToggle) viewToggle.checked = false;
        gallery.classList.remove('comic-view');
        yufiFileHandle = null;
        allImages = [];
        filteredImages = [];
        directories = [];
        sortedChapterDirs = [];
        currentChapterIndex = 0;
        chapterNavigationBottom.style.display = 'none';
    }

    async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        cleanup();
        yufiFileHandle = file;
        statusEl.textContent = 'Analyzing file...';
        try {
            const headerSize = 38;
            const headerBuffer = await yufiFileHandle.slice(0, headerSize).arrayBuffer();
            const headerView = new DataView(headerBuffer);
            const decoder = new TextDecoder('utf-8');
            if (decoder.decode(headerBuffer.slice(0, 6)) !== MAGIC_HEADER_STR) throw new Error("This is not a valid Yuffin file.");
            const version = headerView.getFloat32(6, true);
            if (Math.floor(version) < 3) {
                throw new Error(`Unsupported file version: ${version.toFixed(1)}. Version 3.x is required.`);
            }
            const imageCount = Number(headerView.getBigUint64(10, true));
            const dirCount = headerView.getUint32(18, true);
            const dirTableOffset = Number(headerView.getBigUint64(22, true));
            const fileIndexOffset = Number(headerView.getBigUint64(30, true));
            const dirTableBlob = yufiFileHandle.slice(dirTableOffset, fileIndexOffset);
            const dirTableText = await dirTableBlob.text();
            directories = dirTableText.split('\0').slice(0, dirCount);
            const fileIndexEntrySize = 8;
            const fileIndexSize = imageCount * fileIndexEntrySize;
            const fileIndexBuffer = await yufiFileHandle.slice(fileIndexOffset, fileIndexOffset + fileIndexSize).arrayBuffer();
            const fileIndexView = new DataView(fileIndexBuffer);
            allImages = Array.from({ length: imageCount }, (_, i) => {
                const entryOffset = i * fileIndexEntrySize;
                const offset = fileIndexView.getUint32(entryOffset, true);
                const dirId = fileIndexView.getUint16(entryOffset + 4, true);
                return { offset, dirId };
            });
            populateFilter();
            applyFilter();
        } catch (error) {
            alert(error.message);
            console.error(error);
            statusEl.textContent = 'Error! Please select a valid file.';
            cleanup();
        }
    }

    function applyFilter() {
        const selectedDirId = parseInt(dirFilter.value, 10);
        filteredImages = (selectedDirId === -1)
            ? allImages
            : allImages.filter(img => img.dirId === selectedDirId);
        currentPage = 1;
        
        // Jeśli włączamy Comic View, znajdź aktualny katalog w sortedChapterDirs
        if (viewToggle.checked && selectedDirId !== -1) {
            const selectedDirName = directories[selectedDirId];
            const lowerDirName = selectedDirName.toLowerCase();
            const isChapterDir = /(?:tom_\d+_)?chapter_\d+/i.test(lowerDirName);
            
            if (isChapterDir) {
                // Znajdź indeks w sortedChapterDirs dla aktualnego katalogu
                const chapterIndex = sortedChapterDirs.findIndex(dir => 
                    dir.toLowerCase() === selectedDirName.toLowerCase()
                );
                if (chapterIndex !== -1) {
                    currentChapterIndex = chapterIndex;
                    updateChapterNavigation();
                    renderCurrentChapter();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }
            }
        }
        updateDisplay();
    }

    function updateDisplay() {
        const isComicView = viewToggle.checked;
        gallery.classList.toggle('comic-view', isComicView);
        
        if (isComicView) {
            paginationContainer.style.display = 'none';
            
            // Sprawdź czy mamy wybrany katalog rozdziału
            const selectedDirId = parseInt(dirFilter.value, 10);
            const selectedDirName = selectedDirId !== -1 ? directories[selectedDirId] : null;
            const lowerDirName = selectedDirName ? selectedDirName.toLowerCase() : '';
            const isChapterDir = selectedDirName && /(?:tom_\d+_)?chapter_\d+/i.test(lowerDirName);
            
            if (isChapterDir && sortedChapterDirs.length > 0) {
                // Znajdź indeks aktualnego katalogu w sortedChapterDirs
                const chapterIndex = sortedChapterDirs.findIndex(dir => 
                    dir.toLowerCase() === selectedDirName.toLowerCase()
                );
                
                if (chapterIndex !== -1) {
                    currentChapterIndex = chapterIndex;
                } else {
                    currentChapterIndex = 0;
                }
                
                chapterNavigation.style.display = 'flex';
                chapterNavigationBottom.style.display = 'flex';
                updateChapterNavigation();
                renderCurrentChapter();
            } else if (sortedChapterDirs.length > 0) {
                // Jeśli nie mamy wybranego rozdziału, ale są rozdziały, pokaż pierwszy
                currentChapterIndex = 0;
                chapterNavigation.style.display = 'flex';
                chapterNavigationBottom.style.display = 'flex';
                updateChapterNavigation();
                renderCurrentChapter();
            } else {
                // Brak rozdziałów, pokaż wszystkie obrazy
                chapterNavigation.style.display = 'none';
                chapterNavigationBottom.style.display = 'none';
                renderAllImagesComic();
            }
        } else {
            chapterNavigation.style.display = 'none';
            chapterNavigationBottom.style.display = 'none';
            paginationContainer.style.display = 'flex';
            const totalPages = Math.ceil(filteredImages.length / IMAGES_PER_PAGE) || 1;
            statusEl.textContent = `Found ${filteredImages.length} images on ${totalPages} pages.`;
            setupPaginationControls(totalPages);
            renderPage(currentPage);
        }
    }

    function updateChapterNavigation() {
        if (sortedChapterDirs.length === 0) return;
        const currentChapter = sortedChapterDirs[currentChapterIndex];
        
        // Używaj sformatowanej nazwy do wyświetlania
        const displayName = formatChapterForDisplay(currentChapter);
        currentChapterEl.textContent = `Chapter: ${displayName}`;
        currentChapterBottomEl.textContent = `Chapter: ${displayName}`;
        
        // Znajdź indeks folderu (ignorując wielkość liter)
        const chapterDirId = directories.findIndex(dir => 
            dir.toLowerCase() === currentChapter.toLowerCase()
        );
        
        if (chapterDirId !== -1) {
            dirFilter.value = chapterDirId;
        }
        
        prevChapterBtn.disabled = currentChapterIndex === 0;
        nextChapterBtn.disabled = currentChapterIndex === sortedChapterDirs.length - 1;
        prevChapterBottomBtn.disabled = currentChapterIndex === 0;
        nextChapterBottomBtn.disabled = currentChapterIndex === sortedChapterDirs.length - 1;
    }

    function renderCurrentChapter() {
        if (sortedChapterDirs.length === 0) return;
        const currentChapterDir = sortedChapterDirs[currentChapterIndex];
        
        // Znajdź indeks folderu (ignorując wielkość liter)
        const chapterDirId = directories.findIndex(dir => 
            dir.toLowerCase() === currentChapterDir.toLowerCase()
        );
        
        if (chapterDirId === -1) return;
        
        filteredImages = allImages.filter(img => img.dirId === chapterDirId);
        gallery.innerHTML = '';
        
        const displayName = formatChapterForDisplay(currentChapterDir);
        statusEl.textContent = `${displayName}: ${filteredImages.length} images`;
        
        filteredImages.forEach(imageInfo => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'gallery-item';
            const img = document.createElement('img');
            itemDiv.appendChild(img);
            gallery.appendChild(itemDiv);
            loadImage(imageInfo.offset, img);
        });
    }

    function renderAllImagesComic() {
        gallery.innerHTML = '';
        statusEl.textContent = `Displaying ${filteredImages.length} images in comic view.`;
        filteredImages.forEach(imageInfo => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'gallery-item';
            const img = document.createElement('img');
            itemDiv.appendChild(img);
            gallery.appendChild(itemDiv);
            loadImage(imageInfo.offset, img);
        });
    }

    function renderPage(pageNumber) {
        const totalPages = Math.ceil(filteredImages.length / IMAGES_PER_PAGE) || 1;
        if (pageNumber < 1 || pageNumber > totalPages) return;
        currentPage = pageNumber;
        gallery.innerHTML = '';
        updatePaginationControls(totalPages);
        const startIndex = (pageNumber - 1) * IMAGES_PER_PAGE;
        const endIndex = Math.min(startIndex + IMAGES_PER_PAGE, filteredImages.length);

        for (let i = startIndex; i < endIndex; i++) {
            const imageInfo = filteredImages[i];
            const itemDiv = document.createElement('div');
            itemDiv.className = 'gallery-item';
            const img = document.createElement('img');
            itemDiv.appendChild(img);
            gallery.appendChild(itemDiv);
            loadImage(imageInfo.offset, img);
        }
    }

    async function loadImage(offset, imgElement) {
        try {
            const blockHeaderBuffer = await yufiFileHandle.slice(offset, offset + 8).arrayBuffer();
            const imageSize = new DataView(blockHeaderBuffer).getUint32(4, true);
            const imageBlob = yufiFileHandle.slice(offset + 8, offset + 8 + imageSize);
            const url = URL.createObjectURL(imageBlob);
            imgElement.src = url;
            imgElement.classList.add('loaded');
            imgElement.addEventListener('click', () => openLightbox(offset));
            imgElement.onload = () => URL.revokeObjectURL(url);
        } catch (e) {
            console.error("Error loading image from offset:", offset, e);
            imgElement.alt = "Loading error";
        }
    }

    function setupPaginationControls(totalPages) {
        paginationContainer.innerHTML = '';
        if (totalPages <= 1) return;
        paginationContainer.innerHTML = `<button id="first-btn">« First</button><button id="prev-btn">‹ Previous</button><span class="page-info">Page <input type="number" id="page-input" min="1"> of ${totalPages}</span><button id="go-btn">Go</button><button id="next-btn">Next ›</button><button id="last-btn">Last »</button>`;
        document.getElementById('first-btn').onclick = () => renderPage(1);
        document.getElementById('prev-btn').onclick = () => renderPage(currentPage - 1);
        document.getElementById('next-btn').onclick = () => renderPage(currentPage + 1);
        document.getElementById('last-btn').onclick = () => renderPage(totalPages);
        const pageInput = document.getElementById('page-input');
        const goBtn = document.getElementById('go-btn');
        goBtn.onclick = () => { const page = parseInt(pageInput.value, 10); if (page >= 1 && page <= totalPages) renderPage(page); };
        pageInput.addEventListener('keydown', e => e.key === 'Enter' && goBtn.click());
    }

    function updatePaginationControls(totalPages) {
        if (totalPages <= 1) { paginationContainer.innerHTML = ''; return; }
        document.getElementById('first-btn').disabled = currentPage === 1;
        document.getElementById('prev-btn').disabled = currentPage === 1;
        document.getElementById('next-btn').disabled = currentPage === totalPages;
        document.getElementById('last-btn').disabled = currentPage === totalPages;
        document.getElementById('page-input').value = currentPage;
        document.getElementById('page-input').max = totalPages;
    }

    async function openLightbox(offset) {
        try {
            const blockHeaderBuffer = await yufiFileHandle.slice(offset, offset + 8).arrayBuffer();
            const imageSize = new DataView(blockHeaderBuffer).getUint32(4, true);
            const imageBlob = yufiFileHandle.slice(offset + 8, offset + 8 + imageSize);
            const url = URL.createObjectURL(imageBlob);
            lightboxImage.src = url;
            lightboxImage.onload = () => URL.revokeObjectURL(url);
            lightbox.classList.add('visible');
        } catch (e) {
            console.error("Error opening lightbox:", e);
        }
    }

    function closeLightbox() {
        lightbox.classList.remove('visible');
        lightboxImage.src = "";
    }

    // Chapter navigation
    function goToNextChapter() {
        if (currentChapterIndex < sortedChapterDirs.length - 1) {
            currentChapterIndex++;
            updateChapterNavigation();
            renderCurrentChapter();
            window.scrollTo({ top: 0, behavior: 'auto' });
        }
    }
    
    function goToPrevChapter() {
        if (currentChapterIndex > 0) {
            currentChapterIndex--;
            updateChapterNavigation();
            renderCurrentChapter();
            window.scrollTo({ top: 0, behavior: 'auto' });
        }
    }
    
    // Event handlers
    fileInput.addEventListener('change', handleFileSelect);
    dirFilter.addEventListener('change', applyFilter);
    viewToggle.addEventListener('change', updateDisplay);
    closeButton.addEventListener('click', closeLightbox);
    lightbox.addEventListener('click', e => (e.target === lightbox) && closeLightbox());
    prevChapterBtn.addEventListener('click', goToPrevChapter);
    nextChapterBtn.addEventListener('click', goToNextChapter);
    prevChapterBottomBtn.addEventListener('click', goToPrevChapter);
    nextChapterBottomBtn.addEventListener('click', goToNextChapter);
</script>
</body>
</html>
